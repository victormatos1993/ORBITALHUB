generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String         @id @default(cuid())
  name                String?
  email               String?        @unique
  emailVerified       DateTime?
  image               String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  role                Role           @default(USER)
  password            String?
  phone               String?
  position            String?
  parentAdminId       String?
  accounts            Account[]
  createdEvents       AgendaEvent[]  @relation("EventCreator")
  events              AgendaEvent[]
  createdCategories   Category[]     @relation("CategoryCreator")
  categories          Category[]
  company             Company?
  createdCustomers    Customer[]     @relation("CustomerCreator")
  customers           Customer[]
  createdProducts     Product[]      @relation("ProductCreator")
  products            Product[]
  createdQuotes       Quote[]        @relation("QuoteCreator")
  quotes              Quote[]
  createdSales        Sale[]         @relation("SaleCreator")
  sales               Sale[]
  createdServices     Service[]      @relation("ServiceCreator")
  services            Service[]
  sessions            Session[]
  createdSuppliers    Supplier[]     @relation("SupplierCreator")
  suppliers           Supplier[]
  createdTransactions Transaction[]  @relation("TransactionCreator")
  transactions        Transaction[]
  notifications       Notification[]
  contasFinanceiras   ContaFinanceira[]
  maquinasCartao      MaquinaCartao[]
  parentAdmin         User?          @relation("TeamMembers", fields: [parentAdminId], references: [id])
  teamMembers         User[]         @relation("TeamMembers")
}

/// Central de Notificações — registra todas as notificações geradas pelo sistema
model Notification {
  id             String    @id @default(cuid())
  userId         String                          // tenant dono
  type           String    @default("AGENDA_EVENT") // AGENDA_EVENT | SYSTEM
  title          String
  description    String?

  // Referências opcionais
  eventId        String?                         // AgendaEvent vinculado
  customerId     String?
  customerName   String?

  // Valores financeiros
  expectedAmount Decimal?                        // valor previsto (do serviço/produto)
  actionAmount   Decimal?                        // valor efetivamente gerado na ação

  // Status do ciclo de vida
  // PENDING | CONFIRMED | CANCELLED | ACTED_PDV | DISMISSED
  status         String    @default("PENDING")
  actionAt       DateTime?                       // quando foi atuada

  // Metadados para resumo diário
  dueAt          DateTime                        // quando o evento ficou pendente (startDate)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user           User      @relation(fields: [userId], references: [id])

  @@unique([userId, eventId])                    // 1 notificação por evento por tenant
}


model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Category {
  id           String        @id @default(cuid())
  code         String?
  name         String
  type         String
  color        String?
  level        Int           @default(0)
  parentId     String?
  isSystem     Boolean       @default(false)
  userId       String
  createdById  String?
  parent       Category?     @relation("CategoryTree", fields: [parentId], references: [id])
  children     Category[]    @relation("CategoryTree")
  createdBy    User?         @relation("CategoryCreator", fields: [createdById], references: [id])
  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]
}

model Customer {
  id           String        @id @default(cuid())
  name         String
  email        String?
  phone        String?
  document     String?
  userId       String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  address      String?
  city         String?
  neighborhood String?
  number       String?
  state        String?
  zipCode      String?
  complement   String?
  createdById  String?
  events       AgendaEvent[]
  createdBy    User?         @relation("CustomerCreator", fields: [createdById], references: [id])
  user         User          @relation(fields: [userId], references: [id])
  sales        Sale[]        @relation("CustomerSales")
  transactions Transaction[]
}

model Supplier {
  id           String        @id @default(cuid())
  name         String
  email        String?
  phone        String?
  document     String?
  userId       String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  address      String?
  city         String?
  neighborhood String?
  number       String?
  state        String?
  zipCode      String?
  complement   String?
  createdById  String?
  freightSales Sale[]        @relation("CarrierSales")
  createdBy    User?         @relation("SupplierCreator", fields: [createdById], references: [id])
  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]
}

model Transaction {
  id                 String            @id @default(cuid())
  description        String
  amount             Decimal
  type               String
  date               DateTime
  status             String
  categoryId         String?
  customerId         String?
  supplierId         String?
  quoteId            String?
  userId             String
  saleId             String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  eventId            String?
  createdById        String?
  contaFinanceiraId  String?
  maquinaCartaoId    String?
  paidAt             DateTime?
  competenceDate     DateTime?
  installmentNumber  Int?
  installmentTotal   Int?
  taxaAplicada       Decimal?
  category           Category?         @relation(fields: [categoryId], references: [id])
  contaFinanceira    ContaFinanceira?  @relation(fields: [contaFinanceiraId], references: [id])
  maquinaCartao      MaquinaCartao?    @relation(fields: [maquinaCartaoId], references: [id])
  createdBy          User?             @relation("TransactionCreator", fields: [createdById], references: [id])
  customer           Customer?         @relation(fields: [customerId], references: [id])
  event              AgendaEvent?      @relation(fields: [eventId], references: [id])
  quote              Quote?            @relation(fields: [quoteId], references: [id])
  sale               Sale?             @relation(fields: [saleId], references: [id])
  supplier           Supplier?         @relation(fields: [supplierId], references: [id])
  user               User              @relation(fields: [userId], references: [id])
}

/// Contas financeiras — onde o dinheiro está (Caixa, Banco, Carteira Digital)
model ContaFinanceira {
  id           String        @id @default(cuid())
  name         String
  type         String        // CAIXA | BANCO | CARTEIRA_DIGITAL
  balance      Decimal       @default(0)
  active       Boolean       @default(true)
  isDefault    Boolean       @default(false)
  userId       String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]
}

/// Maquininhas de cartão — cada empresa pode ter múltiplas
model MaquinaCartao {
  id               String        @id @default(cuid())
  name             String
  active           Boolean       @default(true)
  diasRecebimento  Int           @default(30)
  modoRecebimento  String        @default("PARCELADO") // PARCELADO | ANTECIPADO
  userId           String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  user             User          @relation(fields: [userId], references: [id])
  taxas            TaxaMaquina[]
  transactions     Transaction[]
}

/// Taxas por método de pagamento para cada maquininha
model TaxaMaquina {
  id               String        @id @default(cuid())
  maquinaId        String
  metodoPagamento  String        // DEBITO | CREDITO_1X | CREDITO_2X | ... | CREDITO_12X | VOUCHER | PIX
  taxa             Decimal       // 0.035 = 3.5%
  maquina          MaquinaCartao @relation(fields: [maquinaId], references: [id], onDelete: Cascade)

  @@unique([maquinaId, metodoPagamento])
}

model Product {
  id            String        @id @default(cuid())
  name          String
  description   String?
  price         Decimal       @default(0)
  stockQuantity Int           @default(0)
  manageStock   Boolean       @default(true)
  ncm           String?
  sku           String?
  userId        String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  createdById   String?
  events        AgendaEvent[]
  createdBy     User?         @relation("ProductCreator", fields: [createdById], references: [id])
  user          User          @relation(fields: [userId], references: [id])
  quoteItems    QuoteItem[]
  saleItems     SaleItem[]
}

model Sale {
  id             String        @id @default(cuid())
  date           DateTime      @default(now())
  totalAmount    Decimal
  status         String        @default("COMPLETED")
  userId         String
  customerId     String?
  carrierId      String?
  shippingCost   Decimal?
  shippingStatus String?
  freightPaidBy  String?       @default("CLIENTE") // CLIENTE ou EMPRESA (frete grátis para o cliente)
  paymentMethod  String?       // PIX, DINHEIRO, CREDITO, DEBITO, VOUCHER, CHEQUE, CARNE, BOLETO
  paymentType    String?       // A_VISTA, PARCELADO
  installments   Int?          // número de parcelas (para CREDITO, CARNE, BOLETO)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  createdById    String?
  carrier        Supplier?     @relation("CarrierSales", fields: [carrierId], references: [id])
  createdBy      User?         @relation("SaleCreator", fields: [createdById], references: [id])
  customer       Customer?     @relation("CustomerSales", fields: [customerId], references: [id])
  user           User          @relation(fields: [userId], references: [id])
  items          SaleItem[]
  transactions   Transaction[]
}

model SaleItem {
  id         String   @id @default(cuid())
  quantity   Int
  unitPrice  Decimal
  totalPrice Decimal
  saleId     String
  productId  String?
  itemType   String   @default("product")
  serviceId  String?
  product    Product? @relation(fields: [productId], references: [id])
  sale       Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  service    Service? @relation(fields: [serviceId], references: [id])
}

model Service {
  id          String        @id @default(cuid())
  name        String
  description String?
  price       Decimal       @default(0)
  duration    Int?
  category    String?
  active      Boolean       @default(true)
  userId      String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdById String?
  events      AgendaEvent[]
  quoteItems  QuoteItem[]
  saleItems   SaleItem[]
  createdBy   User?         @relation("ServiceCreator", fields: [createdById], references: [id])
  user        User          @relation(fields: [userId], references: [id])
}

model Quote {
  id            String        @id @default(cuid())
  number        Int
  clientName    String
  clientEmail   String?
  clientPhone   String?
  notes         String?
  validUntil    DateTime?
  status        String        @default("DRAFT")
  totalAmount   Decimal       @default(0)
  discount      Decimal       @default(0)
  isRecurring   Boolean       @default(false)
  installments  Int?
  userId        String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  paymentMethod String?
  paymentType   String?
  createdById   String?
  events        AgendaEvent[]
  createdBy     User?         @relation("QuoteCreator", fields: [createdById], references: [id])
  user          User          @relation(fields: [userId], references: [id])
  items         QuoteItem[]
  transactions  Transaction[]
}

model QuoteItem {
  id          String   @id @default(cuid())
  description String
  quantity    Int      @default(1)
  unitPrice   Decimal
  totalPrice  Decimal
  serviceId   String?
  quoteId     String
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  service     Service? @relation(fields: [serviceId], references: [id])
}

model AgendaEvent {
  id                     String        @id @default(cuid())
  title                  String
  type                   String
  startDate              DateTime
  endDate                DateTime
  isLocal                Boolean       @default(false)
  location               String?
  customerName           String?
  userId                 String
  customerId             String?
  productId              String?
  serviceId              String?
  quoteId                String?
  // ── Controle de notificação ──────────────────────────────────────────────
  // null = ainda pendente no sino | CONFIRMED | CANCELLED | ACTED_PDV | DISMISSED
  notificationStatus     String?
  notificationActedAt    DateTime?
  // ── Status financeiro do evento ──────────────────────────────────────────
  // null = sem valor financeiro | PENDING | PAID | PARTIAL | CANCELLED
  paymentStatus          String?
  // ── Status operacional do atendimento ────────────────────────────────────
  // null = não gerenciado | SCHEDULED | CONFIRMED | COMPLETED | CANCELLED | NO_SHOW
  attendanceStatus       String?       @default("SCHEDULED")
  // ── Recorrência ─────────────────────────────────────────────────────
  recurrenceRule         String?       // WEEKLY | BIWEEKLY | MONTHLY | null
  recurrenceCount        Int?          // quantas ocorrências
  recurrenceGroupId      String?       // ID do grupo de recorrência
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt
  createdById            String?
  createdBy              User?         @relation("EventCreator", fields: [createdById], references: [id])
  customer               Customer?     @relation(fields: [customerId], references: [id])
  product                Product?      @relation(fields: [productId], references: [id])
  quote                  Quote?        @relation(fields: [quoteId], references: [id])
  service                Service?      @relation(fields: [serviceId], references: [id])
  user                   User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions           Transaction[]
}

model Company {
  id           String   @id @default(cuid())
  name         String
  tradingName  String?
  document     String?
  email        String?
  phone        String?
  mobile       String?
  address      String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?
  zipCode      String?
  logoUrl      String?
  quoteNotes   String?
  userId       String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Role {
  USER
  ADMIN
  ORACULO
  ADMINISTRADOR
  GERENTE
  VENDEDOR
  FINANCEIRO
  VISUALIZADOR
}
